---
layout: post
title: "Linux Kernel Space Media Transfer Protocol"
date: 2008-12-26
comments: false
categories:
 - Software
---

<div class='post'>
So after a couple years of pondering I have finally begun work on implementing a kernel space driver for the media transfer protocol.<br /><br />Yes, yes, this is my first foray since university into kernel space, but I have had enough of the user-space solutions to implementing the media transfer protocol.  Hundreds of devices have now implemented the darn thing (including my iriver clix if you recall), and what's more the USB.org folks have finally published the <a href="http://www.usb.org/developers/devclass_docs/MTP_1.0.zip">1.0 version of the standard</a>.<br /><br />First here is a bit of the technical reasoning.<br /><br /><ol><br /><li>Already two distinct user-space implementations which both share similar drawbacks. libmtp, and libgphoto</li><br /><li>Dependant on libusb which has stalled in development</li><br /><li>Race condition in device connection, first application to detect and connect blocks any other software from using the device until connection is dropped</li><br /></ol><br /><br />Etc, the current implementation suffers from all the problems that user space drivers suffer from in the monolithic world (even the microsoft implementation has this going on).  Also, it's about time I get my hands dirty in the kernel for pete's sake.<br /><br />So how is this thing going to work you might ask?<br /><br />Well, here is how I see it right now, and others are welcome to chime in on this.<br /><br />The protocol is implemented partly in kernel space, and partly in user-space depending on necessity and appropriateness.<br /><br />Kernel Space Driver (mtp):<br />Connects and manages all operations:<br />Exposes file hierarchies as a mountable file system<br />Implements protocol for transferring straight files.<br />Issues device handles to userspace which can be used asynchronously (no more device pointers!)<br />Automatic device connection<br /><br />User Space Library (libmtp-media)<br />Implements protocol for managing media (including meta-data) (music, pictures, video, etc)<br /><br />User Space Library (libmtp-cal)<br />Implements protocol for managing contact and calendar (vcard, ical, etc)<br /><br />Essentially the protocol implementation will be separated across a variety of locations.<br /><br />Anywho, after an hour or so of fiddling, here is the latest line from dmesg:<br /><br /><pre><br />usb 4-5: new high speed USB device using ehci_hcd and address 9<br />usb 4-5: configuration #1 chosen from 1 choice<br />mtp: USB Skeleton device now attached to USBSkel-192<br />usb 4-5: New USB device found, idVendor=4102, idProduct=112a<br />usb 4-5: New USB device strings: Mfr=1, Product=2, SerialNumber=3<br />usb 4-5: Product: iriver clix<br />usb 4-5: Manufacturer: iriver Limited<br />usb 4-5: SerialNumber: 41dff81c000000f33230303530313031<br />usb 4-5: USB disconnect, address 9<br />mtp: USB Skeleton #192 now disconnected<br /></pre><br /><br />Not much, but hey it's the beginning of the road here.<br /><br />Lastly, if anyone wants to employ me to design this, I am certainly on the market.<br /><br />-Ted Bullock</div>
